<!DOCTYPE html>
<html>
    <head>
        <title>Run JavaScript</title>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    </head>    
<body>
    <div id="data">
        Temperature: <input id="temperature" readonly="true"> <br>
        Humidity: <input id="humidity" readonly="true" > <br>
        Time: <input id="time" readonly="true" >
    </div>
    
    
    <script> 
    let temp = 0;
    let hum = 0;
    let time = "";

// Your existing config object
const firebaseConfig = {
  apiKey: "AIzaSyD38K9ZpLZpFQbGruwO3EnoGSOrhmY45Ug",
  authDomain: "iot-app-20b70.firebaseapp.com",
  databaseURL: "https://iot-app-20b70-default-rtdb.firebaseio.com",
  projectId: "iot-app-20b70",
  storageBucket: "iot-app-20b70.firebasestorage.app",
  messagingSenderId: "206130198957",
  appId: "1:206130198957:web:a8d92d4c0c923d92004924",
  measurementId: "G-HQCMWBSZK4"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const readingsRef = db.ref('readings');

readingsRef.on('value', (snapshot) => {
    if (snapshot.exists()) {
        const data = snapshot.val();
        console.log(`Temperature: ${data.tempdata}C`);
        temp = data.tempdata;
        document.getElementById("temperature").value = temp +"C";
        console.log(`Humidity: ${data.humiditydata}%`);
        hum = data.humiditydata;
        document.getElementById("humidity").value = hum + "%"
        console.log(`Last updated: ${data.timestamp}`);
        time = data.timestamp;
        document.getElementById("time").value = time;
    }
});

// Firestore
const dbFirestore = firebase.firestore();
const readingsCollection = dbFirestore.collection("readings");

readingsCollection.get().then((snapshot) => {
    const data = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data()
    }));
    console.log(data);
    console.log("data length: " + data.length);
    let boolean = true;
    for(let i = 0; i<data.length-1;i++){
        //for every data entry make sure that the timestamp is more than the previous 
        let timestamp1 = data[i].timestamp;
        let timestamp2 = data[i+1].timestamp;

    if(!(timestamp2>timestamp1)){
        boolean = false;
        console.log(i);
    }else{
        boolean = true;
    }
    console.log(boolean);
    }
    console.log("all elements");
});

// Firestore: Fetch the last n readings
        
        const n = 5; // Number of latest readings to fetch

        // Query Firestore for the last `n` elements in descending order
        readingsCollection
            .orderBy("timestamp", "desc") // Order by timestamp in descending order
            .limit(n) // Limit to the last `n` entries
            .get()
            .then((snapshot) => {
                const data = snapshot.docs.map((doc) => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Log the data to the console
                console.log(`Last ${n} readings:`);
                console.log(data)
                data.forEach((reading, index) => {
                    console.log(
                        `${index + 1}. Temperature: ${reading.temperature}, ` +
                        `Humidity: ${reading.humidity}, ` +
                        `Timestamp: ${reading.timestamp}`
                    );
                });
            })
            .catch((error) => {
                console.error("Error fetching data from Firestore:", error);
            });


    </script>

</body>
</html>
